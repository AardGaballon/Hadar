<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!--
     Testers: Shotgun
              Mousie
              Tallimos
              
              
TODO:
Add "sessions" hxp session start/stop (outputs exp over that time)
-->
<muclient>
<plugin
   name="Hadar_Exp_Tacker"
   author="Hadar"
   id="197cdb5126215b1ae7e178ea"
   language="Lua"
   purpose="all the exp"
   save_state="y"
   date_written="2020-01-01 00:00:00"
   requires="4.00"
   version="1.14"
   >

</plugin>

<triggers>
<trigger
   enabled="y"
   match="^You receive (.*) experience points?\."
   omit_from_output="n"
   regexp="y"
   group=""
   script="expGained"
   sequence="100"
  >
</trigger>
<trigger
   enabled="y"
   match="^You receive (.*) bonus experience points"
   omit_from_output="n"
   regexp="y"
   group=""
   script="bonusExpGained"
   sequence="100"
  >
</trigger>
<trigger
   match="^Below the flare, you hear (.*) scream '(.*)'$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^\[\s+10 minutes of double exp started courtesy of (.*)\s+\]$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^Double experience for 10 minutes courtesy of (.*)'s daily blessing.$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^Double experience for 10 minutes courtesy of (.*).$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^You hear a loud roar from (.*) and the world appears calmer for a while..$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^INFO: Bonus experience has now expired\."
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleStop"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^Next (.*) mobs? killed will reward double experience[ ]*(.*)$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleDBStart"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^You have no daily blessing bonus experience kills remaining."
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleDBStop"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   match="^You receive (.*) \'rare kill\' experience bonus."
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="doubleRareKill"
   omit_from_output="n"
  >
  </trigger>
</triggers>

 <aliases>
   <alias
   match="^hxp ?(.*)?"
   enabled="y"
   regexp="y"
   sequence="100"
   send_to="12"
   script="expMain"
  >
  </alias>
  <alias match="^had help$"
	enabled="y"
	sequence="100"
	send_to="12"
	regexp="y"
	keep_evaluating="y"
	>
	<send>
		HadarHelp()
	</send>
     </alias>
</aliases>

<timers>
  <timer
     enabled="y"
     hour="1"
     minute="0"
     second="0.00"
     offset_second="0.00"
     send_to="12"
     script="hourReport"
     >
  </timer>
</timers>
<script>
<![CDATA[
require "serialize"
require "gmcphelper"
dofile(GetInfo(60) .. "aardwolf_colors.lua")
--require "themed_miniwindows"

--my_window = ThemedTextWindow("ExpWindow", 100, 100, 200, 150, "ExpTracker", "center", false, true)

function interp(s, tab)
	if s == nil then
		hadarprint("@RYou forgot to fill in a message please use @Clevel help@R and run the message commands to see which one.")
	else
		return (s:gsub('($%b{})', function(w) return tab[w:sub(3, -2)] or w end))
	end
end

function hadarprint(str,level)

	if level == "debug" and expTracker["GL"].Debug == true then
		AnsiNote(ColoursToANSI("@G[@YDEBUG@G]@W:@w"..str))
	elseif level == "error" then
          AnsiNote(ColoursToANSI("@R[@Mhxp @rERROR@R]@W:@w"..str))
     elseif level == "script" then
          AnsiNote(ColoursToANSI("@G[@CE@cxp@CT@cracker@G]@c"..str))
     else
		AnsiNote(ColoursToANSI(str))
	end
	
end

function OnPluginSaveState ()
	SetVariable ("expTracker", "expTracker = " .. serialize.save_simple (expTracker))
	SetVariable ("exppastfirstinstall", "true")
end -- function OnPluginSaveState

function OnPluginInstall ()
   	if GetVariable ("enabled") == "false" then
		ColourNote ("yellow", "", "Warning: Plugin " .. GetPluginName ().. " is currently disabled.")
		check (EnablePlugin(GetPluginID (), false))
		return
	end -- they didn't enable us last time
	
	hadarprint("had help (to see all of hadar's plugin helpfiles), or hxp help to just see this one","script")
  
	OnPluginEnable ()
end

function OnPluginEnable ()

	expTracker = {}
     expTracker["NR"] = {}
     expTracker["DL"] = {}
     expTracker["HR"] = {}
     expTracker["GL"] = {}
     expTracker["SN"] = {}
     
     
	if GetVariable ("exppastfirstinstall") == "true" then
		assert (loadstring (GetVariable ("expTracker") or "")) ()
	else
          hadarprint("Looks like this is your first install, Lets get you setup! hxp for help","script")
		buildInitial()
	end
     
end

function buildInitial()
	expTracker = {}
     expTracker["NR"] = {}
     expTracker["DL"] = {}
     expTracker["HR"] = {}
     expTracker["GL"] = {}
     expTracker["SN"] = {}
-----------global exptracker vars----------------------------
     expTracker["GL"]["hour"] = true
     expTracker["GL"]["double"] = true
     expTracker["GL"]["normal"] = true
     expTracker["GL"]["Type"] = nil
     expTracker["GL"]["commLog"] = false
     expTracker["GL"]["mainWindow"] = true
     expTracker["GL"]["commLogTab"] = nil
     expTracker["GL"]["Channel"] = "echo"
     expTracker["GL"]["Logo"] = "@G[@CE@cxp@CT@cracker@G]@c"
     expTracker["GL"].Debug = false
-------------------------------------------------------------
-----------Initilize Normal Variables------------------------
     expTracker["NR"].startTime = 0
     expTracker["NR"].totexp = 0
     expTracker["NR"].sec = 0
     expTracker["NR"].min = 0
     expTracker["NR"].message = "${logo}Your kill earned you @R${xp}@c for a @R${length}@c second fight for a total of - @R${totexp}@w"
-------------------------------------------------------------
------------Initilize hour variables-------------------------
     expTracker["HR"].hourEXP = 0
     expTracker["HR"].rareEXP = 0
     expTracker["HR"].bonusEXP = 0
     expTracker["HR"].totexp = 0
     expTracker["HR"].mobsKilled = 0
     expTracker["HR"].message = "${logo}Last Hour you killed @R${kills}@c for a total of @R${totexp}@c which is @R${xp}@c per second@w"
-------------------------------------------------------------
-----------Initilize Double variables------------------------
     expTracker["DL"].hourEXP = 0
     expTracker["DL"].rareEXP = 0
     expTracker["DL"].bonusEXP = 0
     expTracker["DL"].totexp = 0
     expTracker["DL"].mobsKilled = 0
     expTracker["DL"].message = "${logo}Last double you got @R${kills}@c kills for a total of @R${totexp}@c which was @R${xp}@c a second@w"
-------------------------------------------------------------
-----------Initilize Session variables------------------------
     expTracker["SN"].startTime = 0
     expTracker["SN"].Active = false
     expTracker["SN"].totexp = 0
     expTracker["SN"].killexp = 0
     expTracker["SN"].rareexp = 0
     expTracker["SN"].bonusexp = 0
     expTracker["SN"].mobsKilled = 0
     expTracker["SN"].expPerSecond = 0
     expTracker["SN"].expPerMinute = 0
     expTracker["SN"].sec = 0
     expTracker["SN"].min = 0
     expTracker["SN"].message = "${logo}Your session was @R${day}@W:@R${hour}@W:@R${min}@W:@R${sec}@c long, netting @R${totexp}@G[@WK:@R${killexp}@W,B:@R${bonusexp}@W,R:@R${rareexp}@G]@c kills@W: @R${kills}@w"
-------------------------------------------------------------
end


----------------------------------------------------------------------------------------------------
--										 End Standard Template	    							  --
--																								  --
--								         Start Main Stuff										  --
----------------------------------------------------------------------------------------------------

function expMain(name,line,wc)
     local first, rest = wc[1]:match("(%w+)%s*(.*)")
     
     if first == nil then
          HadarHelp()
          return
     end
     
     first = string.lower(first)
     
     if first == "set" then
          expDoubleSet(rest)
     elseif first == "select" then
          expSelectReport(rest)
     elseif first == "channel" then
          expSetChannel(rest)
     elseif first == "debug" then
          if expTracker["GL"].Debug == true then
               expTracker["GL"].Debug = false
               hadarprint("@CD@cebug messages turned @Goff@w")
               SaveState()
          else
               expTracker["GL"].Debug = true
               hadarprint("@CD@cebug messages turned @Gon@w")
               SaveState()
          end
     elseif first == "help" then
          HadarHelp()
     elseif first == "see" then
          seeStatus(rest)
     elseif first == "off" then
          expTracker["GL"]["hour"] = false
          expTracker["GL"]["double"] = false
          expTracker["GL"]["normal"] = false
          hadarprint("All Messages turned @ROFF@w","script")
          SaveState()
     elseif first == "on" then
          expTracker["GL"]["hour"] = true
          expTracker["GL"]["double"] = true
          expTracker["GL"]["normal"] = true
          hadarprint("All Messages turned @GON@w","script")
          SaveState()
     elseif first == "fullreset" then
          buildInitial()
          hadarprint("All Variables have been reset to default","script")
     elseif first == "show" then
          showReport(rest)
     elseif first == "session" then
          expSession(rest)
     elseif first == "report" then
          expWindow(rest)
     else
          HadarHelp()
     end
     
end

function expTimeDiff(t2,t1,script)
	local d1,d2,carry,diff = os.date('*t',t1),os.date('*t',t2),false,{}
	local colMax = {60,60,24,os.date('*t',os.time{year=d1.year,month=d1.month+1,day=0}).day,12}
	d2.hour = d2.hour - (d2.isdst and 1 or 0) + (d1.isdst and 1 or 0) -- handle dst
	for i,v in ipairs({'sec','min','hour','day','month','year'}) do
		diff[v] = d2[v] - d1[v] + (carry and -1 or 0)
		carry = diff[v] < 0
		if carry then diff[v] = diff[v] + colMax[i] end
	end
	for i,v in pairs(diff) do
		expTracker[script][i] = v
	end
	return diff
end

function OnPluginBroadcast(msg, id, name, text)

	if id == "3e7dedbe37e44942dd46d264" then -- message from the GMCP Handler
		if (text == "char.status") then
			res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char")
		
			assert(loadstring("LoadInfo = "..gmcparg or "")) ()
			currentState = tonumber(gmcp("char.status.state"))
		
			for i,v in pairs(LoadInfo) do
				if i == "status" then
                         for k,l in pairs(v) do
                              if k == "state" and tonumber(l) == 8 then
                                   if expTracker["NR"].startTime == 0 then
                                        hadarprint("start timer","debug")
                                        expTracker["NR"].startTime = os.time()
                                   end
                              end
                         end
                    end
			end -- end for
		end --end if char status
	end
end


function expGained(name, line, wc)
     local t = utils.split(wc[1],"+")
     for i,v in pairs(t) do
          buildMessage(tonumber(v))
          expTracker["HR"].hourEXP = tonumber(expTracker["HR"].hourEXP)+tonumber(v)
          if expTracker["DL"].Active == true then
               expTracker["DL"].hourEXP = tonumber(expTracker["DL"].hourEXP)+tonumber(v)
          end
          
          if expTracker["SN"].Active == true then
               expTracker["SN"].totexp = tonumber(expTracker["SN"].totexp)+tonumber(v)
               expTracker["SN"].killexp = tonumber(expTracker["SN"].killexp)+tonumber(v)
          end
     end
     expTracker["HR"].mobsKilled = tonumber(expTracker["HR"].mobsKilled)+1
     if expTracker["DL"].Active == true then
          expTracker["DL"].mobsKilled = tonumber(expTracker["DL"].mobsKilled)+1
     end
     if expTracker["SN"].Active == true then
          expTracker["SN"].mobsKilled = tonumber(expTracker["SN"].mobsKilled)+1
     end
     
end

function bonusExpGained(name, line, wc)
local t = utils.split(wc[1],"+")
     for i,v in pairs(t) do
          buildMessage(v)
          expTracker["HR"].bonusEXP = tonumber(expTracker["HR"].bonusEXP)+tonumber(v)
          if expTracker["DL"].Active == true then
               expTracker["DL"].bonusEXP = tonumber(expTracker["DL"].bonusEXP)+tonumber(v)
          end
          
          if expTracker["SN"].Active == true then
               expTracker["SN"].totexp = tonumber(expTracker["SN"].totexp)+tonumber(v)
               expTracker["SN"].bonusexp = tonumber(expTracker["SN"].bonusexp)+tonumber(v)
          end
     end
end

function doubleRareKill(name, line, wc)
local t = utils.split(wc[1],"+")
     for i,v in pairs(t) do
          buildMessage(v)
          expTracker["HR"].rareExp = tonumber(expTracker["HR"].rareEXP)+tonumber(v)
          if expTracker["DL"].Active == true then
               expTracker["DL"].rareExp = tonumber(expTracker["DL"].rareEXP)+tonumber(v)
          end
          if expTracker["SN"].Active == true then
               expTracker["SN"].totexp = tonumber(expTracker["SN"].totexp)+tonumber(v)
               expTracker["SN"].rareexp = tonumber(expTracker["SN"].rareexp)+tonumber(v)
          end
     end
     
end

function buildMessage(param)

     expTracker["NR"].totexp = tonumber(expTracker["NR"].totexp)+tonumber(param)
     expTracker["HR"].totexp = tonumber(expTracker["HR"].totexp)+tonumber(param)
     if expTracker["DL"].Active == true then
          expTracker["DL"].totexp = tonumber(expTracker["DL"].totexp)+tonumber(param)
     end
     
     expTracker["GL"].Type = "NR"
     
     AddTimer ("makeexpoutput", 0, 0, .1, "", timer_flag.Enabled + timer_flag.OneShot, "makeOutputNormal") 
end

function makeOutputNormal()
     if expTracker["NR"].startTime == 0 then
          expTracker["NR"].sec = 0
          expTracker["NR"].min = 0
     else
          expTimeDiff(os.time(),expTracker["NR"].startTime,"NR")
     end
     
     local exprate = expTracker["NR"].totexp
     
     if expTracker["NR"].sec == 0 and expTracker["NR"]["min"] == 0 and expTracker["GL"].Type == "NR" then
          expTracker["NR"].sec = 1
     end
     
     local expsec = tonumber(expTracker["NR"].sec)+tonumber(expTracker["NR"].min)*60
     
     expTracker["NR"].expsec = tonumber(expTracker["NR"].sec)+tonumber(expTracker["NR"].min)*60
     expTracker["NR"].rate = tonumber(exprate)/tonumber(expsec)
     expTracker["NR"].rate = tonumber(string.format("%2.2g",expTracker["NR"].rate))
     expTracker["GL"].Type = "NR"
     
     makeOutput()
     --setWindowText()
     
     
     charstatus = gmcp("char.status") -- fetch char.status and return it as a Lua table
     myState = tonumber(charstatus.state)
     
     if tonumber(myState) == 8 then
          expTracker["NR"].totexp = 0
     else
          expTracker["NR"].totexp = 0
          expTracker["NR"].startTime = 0
          expTracker["NR"].sec = 0
          expTracker["NR"].min = 0
     end
end

function makeOutput()
     local message

     if expTracker["GL"].Type == "NR" and expTracker["GL"]["normal"] == true then
          message = interp(expTracker["NR"].message, {xp = expTracker["NR"].rate, totexp = expTracker["NR"].totexp, length = expTracker["NR"].expsec,logo = expTracker["GL"].Logo})
     elseif expTracker["GL"].Type == "HR" and expTracker["GL"]["hour"] == true then
          message = interp(expTracker["HR"].message, {xp = expTracker["HR"].rate, totexp = expTracker["HR"].totexp, kills = expTracker["HR"].mobsKilled,logo = expTracker["GL"].Logo})
     elseif expTracker["GL"].Type == "DL" and expTracker["GL"]["double"] == true then
          message = interp(expTracker["DL"].message, {xp = expTracker["DL"].rate, totexp = expTracker["DL"].totexp, kills = expTracker["DL"].mobsKilled,logo = expTracker["GL"].Logo})
     elseif expTracker["GL"].Type == "SN" then
          message = interp(expTracker["SN"].message, {
          month = expTracker["SN"].month,
          day = expTracker["SN"].day,
          hour = expTracker["SN"].hour,
          min = expTracker["SN"].min,
          sec = expTracker["SN"].sec,
          totexp = expTracker["SN"].totexp,
          killexp = expTracker["SN"].killexp,
          rareexp = expTracker["SN"].rareexp,
          bonusexp = expTracker["SN"].bonusexp,
          kills = expTracker["SN"].mobsKilled,
          expsec = expTracker["SN"].expPerSecond,
          expmin = expTracker["SN"].expPerMinute,
          logo = expTracker["GL"].Logo})
     end
     
     if message ~= nil then
          
          if expTracker["GL"]["mainWindow"] == true then
               if expTracker["GL"]["Channel"] == "echo" or expTracker["GL"]["Channel"] == "print" then
                    hadarprint(message)
               else
                    SendSpecial(expTracker["GL"]["Channel"] .. " " ..message)
               end
          end
          
          if expTracker["GL"]["commLog"] == true then
               CallPlugin("b555825a4a5700c35fa80780","storeFromOutside",message, expTracker["GL"]["commLogTab"], true)
          end
          
          if expTracker["GL"]["commLog"] == false and expTracker["GL"]["mainWindow"] == false then
               hadarprint("You have both reporting to Comm log and reporting to main window off, cant report","error")
          end
          
     end
end

function expDoubleSet(param)
     param = string.lower(param)
     if param == "normal" then
          HadarBackup = expTracker["NR"].message
		expTracker["NR"].message = utils.inputbox ("${logo} - Shows the logo of the script\n${xp} - shows the rate of exp earned per second\n${totexp} - shows total exp earned\n${length} - how long in seconds the fight took", "look of normal exp tracker", expTracker["NR"].message, "Courier", 9)
		
		if expTracker["NR"].message ~= nil then
			hadarprint("Kills message will look like@W: @w"..expTracker["NR"].message,"script")
		else
			expTracker["NR"].message = HadarBackup
		end
     elseif param == "double" then
          HadarBackup = expTracker["DL"].message
		expTracker["DL"].message = utils.inputbox ("${logo} - Shows the logo of the script\n${xp} - shows the rate of exp earned per second\n${totexp} - shows total exp earned\n${kills} - shows how many kills you got", "look of double exp tracker", expTracker["DL"].message, "Courier", 9)
		
          if expTracker["DL"].message ~= nil then
			hadarprint("Double message will look like@W: @w"..expTracker["DL"].message,"script")
		else
			expTracker["DL"].message = HadarBackup
		end
     elseif param == "hour" then
          HadarBackup = expTracker["HR"].message
		expTracker["HR"].message = utils.inputbox ("${logo} - Shows the logo of the script\n${xp} - shows the rate of exp earned per second\n${totexp} - shows total exp earned\n${kills} - shows how many kills you got", "look of hour tracker", expTracker["HR"].message, "Courier", 9)
		
		if expTracker["NR"].message ~= nil then
			hadarprint("Hourly message will look like@W: @w"..expTracker["NR"].message,"script")
		else
			expTracker["NR"].message = HadarBackup
		end
     elseif param == "logo" then
          HadarBackup = expTracker["GL"]["Logo"]
		expTracker["GL"]["Logo"] = utils.inputbox ("How you would like the logo to look if using it", "Logo", expTracker["GL"]["Logo"], "Courier", 9)
		
		if expTracker["GL"]["Logo"] ~= nil then
			hadarprint("Logo will look like@W: @w"..expTracker["GL"].Logo,"script")
		else
			expTracker["GL"]["Logo"] = HadarBackup
		end
     elseif param == "session" then
          HadarBackup = expTracker["SN"].message
		expTracker["SN"].message = utils.inputbox ("${month} - shows if session has been running a month\n${day} - shows if session has been running 1+ days\n${hour} - session hours\n${min} - session minutes\n${sec} - session seconds\n${totexp} - total exp over session\n${killexp} - how much exp from just kills\n${rareexp} - rare mobs exp\n${bonusexp} - bonus exp\n${kills} - how many kills\n${logo} - shows logo", "Logo", expTracker["GL"]["Logo"], "Courier", 9)
		
		if expTracker["SN"].message ~= nil then
			hadarprint("Session message will look like@W: @w"..expTracker["SN"].message,"script")
		else
			expTracker["SN"].message = HadarBackup
		end
     else
          hadarprint("@cYou need to input one of the following@w: @Gnormal@w, @Gdouble@w,@G hour@w, @Glogo @Wor @Gsession @C.@c.@C. @YEG:@R xhp set normal@w","error")
     end
     SaveState()
end

function doubleStart()
     expTracker["DL"].Active = true
     expTracker["DL"].startTime = os.time()
end

function doubleStop()
     
     expTimeDiff(os.time(),expTracker["DL"].startTime,"DL")
     expTracker["GL"].Type = "DL"
     local exprate = expTracker["DL"].totexp
     local expsec = tonumber(expTracker["DL"].sec)+tonumber(expTracker["DL"].min)*60
     expTracker["DL"].rate = string.format ("%2.5g", (tonumber(exprate)/tonumber(expsec)))
     makeOutput()
     
     expTracker["DL"].Active = false
     expTracker["DL"].totexp = 0
     expTracker["DL"].hourEXP = 0
     expTracker["DL"].bonusEXP = 0
     expTracker["DL"].rareExp = 0
     expTracker["DL"].mobsKilled = 0
end

function doubleDBStart()
    --maybe ill add a future thing to track how you used your db doubles
end

function doubleDBStop()
     --maybe ill add a future thing to track how you used your db doubles
end

function hourReport()

     local expsec = 3600
     local exprate = expTracker["HR"].totexp
     
     expTracker["HR"].rate = string.format ("%2.5g", (tonumber(exprate)/tonumber(expsec)))
    
     expTracker["GL"].Type="HR"
     
     makeOutput()
     
     expTracker["HR"].hourEXP = 0
     expTracker["HR"].rareEXP = 0
     expTracker["HR"].bonusEXP = 0
     expTracker["HR"].totexp = 0
     expTracker["HR"].mobsKilled = 0
end

function expSetChannel(str)
     if str ~= nil and str ~= "" and str ~= " " then
		expTracker["GL"].Channel = str
		hadarprint("Default channel set to@w: @G" .. expTracker["GL"].Channel,"script")
	else
          hadarprint("Current Channel:"..expTracker["GL"].Channel,script)
		hadarprint("@cPlease use the following command@W:@Ghxp channel <channel you want to output to>@w","error")
	end
     
     SaveState()
end

function expSelectReport(param)
     param = string.lower(param)
     
     if param == "hour" then
          if expTracker["GL"]["hour"] then
               expTracker["GL"]["hour"] = false
               hadarprint("You will now @RNOT@c report exp on the hour","script")
          else
               expTracker["GL"]["hour"] = true
               hadarprint("You will now @Greport@c exp on the hour","script")
          end
     elseif param == "double" then
          if expTracker["GL"]["double"] then
               expTracker["GL"]["double"] = false
               hadarprint("You will now @RNOT@c report exp after double","script")
          else
               expTracker["GL"]["double"] = true
               hadarprint("You will now @Greport@c exp after double","script")
          end
     elseif param == "kill" or param == "kills" then
          if expTracker["GL"]["normal"] then
               expTracker["GL"]["normal"] = false
               hadarprint("You will now @RNOT@c report exp after a kill","script")
          else
               expTracker["GL"]["normal"] = true
               hadarprint("You will now @Greport@c exp after a kill","script")
          end
     else
          hadarprint("@cPlease use the following command@W:@Ghxp select <hour or double or kill>@w","error")
     end
     
     SaveState()
end

function seeStatus(param)
     if param == nil then
          hadarprint("To see status it cant be blank please choose, hour, double or kill","error")
          return
     end
     
     param = string.lower(param)
     
     if param == "hour" then
          if expTracker["GL"]["hour"] then hadarprint("Hour is @Gactive@w","script") else hadarprint("Hour is @Rinactive@w","script") end
     elseif param == "double" then
          if expTracker["GL"]["double"] then hadarprint("Double is @Gactive@w","script") else hadarprint("Double is @Rinactive@w","script") end
     elseif param == "kill" or param == "kills" then
          if expTracker["GL"]["normal"] then hadarprint("Kills is @Gactive@w","script") else hadarprint("Kills is @Rinactive@w","script") end
     else
          if expTracker["GL"]["hour"] then hadarprint("Hour is @Gactive@w","script") else hadarprint("Hour is @Rinactive@w","script") end
          if expTracker["GL"]["double"] then hadarprint("Double is @Gactive@w","script") else hadarprint("Double is @Rinactive@w","script") end
          if expTracker["GL"]["normal"] then hadarprint("Kills is @Gactive@w","script") else hadarprint("Kills is @Rinactive@w","script") end
     end
end

function expSession(str)
     if str == nil then
          hadarprint("You need to give an argument","error")
          return
     end
     
     if str == "start" then
          if expTracker["SN"].Active ~= true then
               expTracker["SN"].Active = true
               expTracker["SN"].startTime = os.time()
               hadarprint("You have started an exp Session, use @Ghxp session stop@c to end","script")
               SaveState()
          else
               hadarprint("You already have a session running use @Ghxp session stop@c to end","script")
          end
     elseif str == "stop" then
     
          if expTracker["SN"].Active == true then
          
          expTimeDiff(os.time(),expTracker["SN"].startTime,"SN")
          expTracker["GL"].Type = "SN"
          local exprate = expTracker["SN"].totexp
          
          local expsec = tonumber(expTracker["SN"].sec)+tonumber(expTracker["SN"].min)*60
          local expmin1 = math.ceil(tonumber(expTracker["SN"].sec)/60)
          local expmin2 = tonumber(expTracker["SN"].min)
          local expmin3 = math.floor(tonumber(expTracker["SN"].hour)*60)
          local expmin = expmin1+expmin2+expmin3
          
          expTracker["SN"].expPerSecond = string.format ("%2.5g", (tonumber(exprate)/tonumber(expsec)))
          expTracker["SN"].expPerMinute = string.format ("%2.5g", (tonumber(exprate)/tonumber(expmin)))

          makeOutput()
          
          expTracker["SN"].totexp = 0
          expTracker["SN"].killexp = 0
          expTracker["SN"].rareexp = 0
          expTracker["SN"].bonusexp = 0
          expTracker["SN"].mobsKilled = 0
          expTracker["SN"].expPerSecond = 0
          expTracker["SN"].expPerMinute = 0
          expTracker["SN"].Active = false
          
          SaveState()
          
          else
               hadarprint("You DO NOT have a session running use @Ghxp session start@c to begin","script")
          end
     elseif str == "status" then
     
          if expTracker["SN"].Active == true then
               local exprate = expTracker["SN"].totexp
          
               local expsec = tonumber(expTracker["DL"].sec)+tonumber(expTracker["DL"].min)*60
               local expmin = math.ceil(tonumber(expTracker["DL"].sec)/60)+tonumber(expTracker["DL"].min)+math.floor(tonumber(expTracker["DL"].hour)*60)
          
               expTracker["SN"].expPerSecond = string.format ("%2.5g", (tonumber(exprate)/tonumber(expsec)))
               expTracker["SN"].expPerMinute = string.format ("%2.5g", (tonumber(exprate)/tonumber(expmin)))
               expTimeDiff(os.time(),expTracker["SN"].startTime,"SN")
               expTracker["GL"].Type = "SN"

               makeOutput()
          else
               hadarprint("You DO NOT have a session running use @Ghxp session start@c to begin","script")
          end
     else
          hadarprint("@cPlease use the following command@W:@Ghxp session <start|stop|status>@w","error")
     end
end

function showReport(report)
     local repchan
     
     if report == nil then
          hadarprint("You need to supply a type, EG hxp show hour say","error")
          return
     end
     
     local first, second = report:match("(%w+)%s*(.*)")
     
     if second == nil or second == "" or second == " " then
          repchan = expTracker["GL"].Channel
     else
          repchan = rest
     end
     
     if first == "double" and expTracker["DL"].Active == true then
          expTimeDiff(os.time(),expTracker["DL"].startTime,"DL")
          expTracker["GL"].Type = "DL"
          local exprate = expTracker["DL"].totexp
          local expsec = tonumber(expTracker["DL"].sec)+tonumber(expTracker["DL"].min)*60
          expTracker["DL"].rate = string.format ("%2.5g", (tonumber(exprate)/tonumber(expsec)))
          local repmsg = "Your Double is currently at @R"..expTracker["DL"].mobsKilled .."@c for a total of @R"..expTracker["DL"].totexp.. " @cWith an avg of @R"..expTracker["DL"].rate.."@c exp/second@w"
          
          if repchan == "echo" or repchan == "print" then
               hadarprint(repmsg,"script")
          else
               SendSpecial(repchan .. " " .. repmsg)
          end
     elseif first == "double" and expTracker["DL"].Active == false then
          hadarprint("Double is not currently running","error")
     end
     
     if first == "hour" and expTracker["GL"]["hour"] == true then
          local repmsg = "Your Hour is currently at @R"..expTracker["HR"].mobsKilled .."@c for a total of @R"..expTracker["HR"].totexp
           if repchan == "echo" or repchan == "print" then
               hadarprint(repmsg,"script")
          else
               SendSpecial(repchan .. " " .. repmsg)
          end
     end
end

function expWindow(str)
     if str == nil or str == "" or str == " " then
          hadarprint("@cYou need to give an argument EG: @Ghxp report main","error")
          return
     end
     
     local first, second = str:match("(%w+)%s*(.*)")
     
     first = string.lower(first)
     
     if second == " " or second == "" then
          second = nil
     end
       

     if first == "main" and second == nil then
          if expTracker["GL"]["mainWindow"] == true then
               expTracker["GL"]["mainWindow"] = false
               hadarprint("You will @RNOT @creport exp to the main window","script")
          else
               expTracker["GL"]["mainWindow"] = true
               hadarprint("You @GWILL@c report exp to the main window","script")
          end
     elseif first == "main" and second == "on" then
          expTracker["GL"]["mainWindow"] = true
          hadarprint("You @GWILL@c report exp to the main window","script")
     elseif first == "main" and second == "off" then
          expTracker["GL"]["mainWindow"] = false
          hadarprint("You will @RNOT @creport exp to the main window","script")
     elseif first == "comm" and second == nil then
          if expTracker["GL"]["commLog"] == true then
               expTracker["GL"]["commLog"] = false
               hadarprint("You will @RNOT @creport exp to the comm window","script")
          else
               expTracker["GL"]["commLog"] = true
               hadarprint("You @GWILL@c report exp to the comm window","script")
          end
     elseif first == "comm" and second == "on" then
          expTracker["GL"]["commLog"] = true
          hadarprint("You @GWILL@c report exp to the main window","script")
     elseif first == "comm" and second == "off" then
          expTracker["GL"]["commLog"] = false
          hadarprint("You will @RNOT @creport exp to the main window","script")
     end
     
     if second ~= nil and second ~= "on" and second ~= "off" then
          expTracker["GL"]["commLogTab"] = second
          hadarprint("You will now report exp to the @W"..second.."@w communication log","script")
     end
     
     SaveState()
end

--[[function setWindowText()
     my_window:clear()
     my_window:add_text("I have gained "..expTracker["NR"].totexp.." exp")
end]]

function HadarHelp()
hadarprint("@x086+----------------------------@g[@CE@cxp@CT@cracker@g]@x086------------------------------+")
hadarprint("@x086| @x214hxp help                @x110- @x214Displays this helpfile                    @x086 |")
hadarprint("@x086| @x208hxp select <type>       @x110- @x208Toggles xp tracker (hour,double,kills) @x086    |")
hadarprint("@x086|                           @REG@W.@G hxp select kills@x208 to turn it off        @x086|")
hadarprint("@x086| @x214hxp channel <channel>   @x110- @x214no arguments displays the channel      @x086    |")
hadarprint("@x086|                           @REG@W.@G hxp channel spouse                     @x086|")
hadarprint("@x086| @x208hxp see <all|type>      @x110- @x208Shows you if type is active all shows all@x086  |")
hadarprint("@x086| @x214hxp show <type>         @x110- @x214Shows current hour or double(if running)@x086   |")
hadarprint("@x086| @x208hxp report <scren> <log>@x110- @x208screen main or comm, log = comm log@x086        |")
hadarprint("@x086|                           @REG@W.@G hxp report comm expTracker            @x086 |")
hadarprint("@x086|                           @REG@W.@G hxp report main off                   @x086 |")
hadarprint("@x086| @x214hxp session <command>   @x110- @x214Start, Stop, Status .. tracks exp/kill over@x086|")
hadarprint("@x086|                           @x214a time between start and stop@x086              |")
hadarprint("@x086+----------------------------------------------------------------------+")
end


--[[
+----------------------------@g[@CE@cxp@CT@cracker@g]@x086------------------------------+")
| hxp help                - Displays this helpfile                     |
| hxp select <type>       - Toggles xp tracker (hour,double,kills)     |
|                           EG. hxp select kills to turn it off        |
| hxp channel <channel>   - no arguments displays the channel          |
|                           EG. hxp channel spouse                     |
| hxp see <all|type>      - Shows you if type is active all shows all  |
| hxp show <type>         - Shows current hour or double(if running)   |
| hxp report <scren> <log>- screen main or comm, log = comm log        |
|                           EG. hxp report comm expTracker             |
|                           EG. hxp report main off                    |
| hxp session <command>   - Start, Stop, Status .. tracks exp/kill over|
|                           a time between start and stop              |
| hxp set <thing>         - Sets the message output for reports        |
|                         - (kill,double,hour,logo,session)            |
+----------------------------------------------------------------------+
]]


]]>
</script> 

</muclient>
