<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Hadar_Vorpal"
   author="Hadar"
   id="718f73b7d7c6a1250b77aa0e"
   language="Lua"
   purpose="Quick and dirty vorpal counter"
   date_written="2016-11-30"
   requires="4.98"
   version="1.0"
   save_state="y"
   >
<description trim="y">
<![CDATA[
mmm mobs losing heads
]]>
</description>

</plugin>

<include name="constants.lua"/>

<!--  Triggers  -->
<triggers>
  <trigger
   enabled="y"
   match="^Your (.*) glows brightly and almost decapitates (.*).$"
   regexp="y"
   send_to="12"
   script="VorpCount"
   sequence="100"
  >
  </trigger>
</triggers>

<aliases>
    <alias
   match="^vorpshow ?(.*)?$"
   enabled="y"
   send_to="12"
   sequence="100"
   script="VorpShow"
  >
  </alias>
      <alias
   match="vorpset *"
   enabled="y"
   send_to="12"
   sequence="100"
   script="vorpset"
  >
  </alias>
</aliases>

<script>
<![CDATA[
require "checkplugin"
require "serialize"

function OnPluginInstall ()
	if GetVariable ("enabled") == "false" then
		ColourNote ("yellow", "", "Warning: Plugin " .. GetPluginName ().. " is currently disabled.")
		check (EnablePlugin(GetPluginID (), false))
		return
	end -- they didn't enable us last time
  
	OnPluginEnable ()
end -- endinstall

function OnPluginEnable ()
	vorpalTotal = 0
	vorpalMort = 0
	if GetVariable ("vorpPastFirstInstall") == "true" then
		assert (loadstring (GetVariable ("vorpalTotal") or "")) ()
		assert (loadstring (GetVariable ("vorpalMort") or "")) ()
	end
end -- endenable

function OnPluginSaveState ()
	SetVariable ("vorpalTotal", serialize.save ("vorpalTotal"))
	SetVariable ("vorpalMort", serialize.save ("vorpalMort"))
	SetVariable ("vorpPastFirstInstall", "true")
end --end save state

function VorpCount(name, line, wildcards)
	if vorpalMort then
		vorpalMort = vorpalMort+1
	else
		vorpalMort = 1
	end

	if vorpalTotal then
		vorpalTotal = vorpalTotal+1
	else
		vorpalTotal = 1
	end

	SendSpecial("gt @CV@corpal @C(@R"..vorpalMort.."@C/@R"..vorpalTotal.."@C)@w")
	SaveState()
end

function VorpShow()
	SendSpecial("echo @CV@corpal @C(@R"..vorpalMort.."@C/@R"..vorpalTotal.."@C)@w")
end

function vorpset(name, lines, wildcards)
	vorpalMort = 1
	vorpalTotal = wildcards[1]
	SaveState()
end

function VorpReset()
	vorpalMort = 0 
	print("Boom baby, vorpals reset!")
end
]]>
</script>

</muclient>